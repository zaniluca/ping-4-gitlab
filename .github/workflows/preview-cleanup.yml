name: Preview Cleanup
on:
  push:
    branches:
      - master
    paths:
      - "**.ts"
      - "**.tsx"
      - "**.js"
      - "**.json"
      - "**.lock"
      - "!eas.json"

jobs:
  preview:
    name: Preview Cleanup
    runs-on: ubuntu-latest
    steps:
      - name: Check for EXPO_TOKEN
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets."
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Configure project
        run: |
          eas init --id bdcab203-d9ce-48aa-95db-938dbfe1be17 --force --non-interactive

      - name: Test eas channels:list
        run: eas channel:list --json --non-interactive

      - name: Cleanup preview
        shell: bash
        run: |
          EXPO_DEBUG=true eas channel:list --json --non-interactive > channels.json
          echo `EXPO_DEBUG=true eas channel:list --json --non-interactive > channels.json`

          channels=`jq '.currentPage[] .name' ./channels.json`

          echo $channels
          echo "Looking for $GITHUB_REF_NAME"

          if printf '%s\0' "${channels[@]}" | grep -Fxqz -- '$GITHUB_REF_NAME'; then
            eas channel:delete --non-interactive $GITHUB_REF_NAME
            eas branch:delete --non-interactive $GITHUB_REF_NAME
          else
            echo "Preview channel not found"
          fi
